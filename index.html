<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Navidad en Julio 2021!</title>
    <meta name="author" content="Santiago Méndez" />
    <link rel="shortcut icon" href="images/Holly.ico" />
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script src="js/jquery.youtube-background.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Anonymous+Pro&family=Source+Serif+Pro:wght@200;300;400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/estilo.css" />
  </head>

  <body>
    <div class="everything">
      <p class="hashtag">
        #navidadenjulio:
        <a
          href="https://twitter.com/search?q=%23navidadenjulio&src=typeahead_click&f=live"
          target="_blank"
          >Twitter</a
        >
        /
        <a
          href="https://www.instagram.com/explore/tags/navidadenjulio/"
          target="_blanket"
          >Instagram</a
        >
      </p>
      <a
        class="github"
        href="https://github.com/twinysam/navidadenjulio"
        target="_blank"
        ><img src="images/GitHub-Mark-Light-32px.png" alt="Github icon"
      /></a>
      <canvas id="c"></canvas>
      <div id="curtain" class="overlay">
        <div class="container">
          <div class="countdown">
            <p>
              <a
                href="https://www.twitch.tv/alexismoyanopuntocom"
                target="_blank"
                >Alexis Moyano Music Hall</a
              >
              presenta:
            </p>
            <h1>Navidad en Julio</h1>
            <p>Cuenta regresiva:</p>
            <div id="clock"></div>

            <br />
            <hr />
            <div class="botones">
              <a href="cronica.html" class="boton">Crónica</a>
              <a href="musica.html" class="boton discord" target="_blank"
                >Música</a
              >
              <a href="peliculas.html" class="boton peli">Películas</a>
            </div>
          </div>
        </div>
      </div>

      <div
        id="ytbg"
        data-ytbg-fade-in="true"
        data-youtube="https://www.youtube.com/watch?v=vI1NwsE3wK4"
      ></div>
    </div>
    <script src="js/moment.min.js"></script>
    <script src="js/moment-timezone-with-data.min.js"></script>
    <script src="js/jquery.countdown.min.js"></script>
    <script>
      $(document).ready(function () {
        var navidadJulio = moment.tz(
          "2021-07-20 00:00:00",
          "America/Argentina/Buenos_Aires"
        );

        $("#clock").countdown(navidadJulio.toDate(), function (event) {
          $(this).html(
            event.strftime(
              "" +
                '<div class="time">%D  <span class="labels">días</span></div>' +
                '<div class="time">%H  <span class="labels">horas</span></div>' +
                '<div class="time">%M  <span class="labels">minutos</span></div>' +
                '<div class="time">%S <span class="labels">segundos</span></div>'
            )
          );
        });
        jQuery("[data-youtube]").youtube_background({
          "play-button": false,
        });

        // check if countdown is finished
        setInterval(function () {
          var now = moment();
          const chequeando = [
            navidadJulio.isSame(now, "day"),
            navidadJulio.isSame(now, "hour"),
            navidadJulio.isSame(now, "minute"),
            navidadJulio.isSame(now, "second"),
          ];
          if (chequeando.indexOf(false) === -1) {
            $("#clock").countdown("pause");
            $("#clock").html('<div class="xmas">¡Feliz Navidad!</div>');
            $("#curtain").addClass("darker");
            var gl = c.getContext("webgl", { preserveDrawingBuffer: true }),
              w = (c.width = window.innerWidth),
              h = (c.height = window.innerHeight),
              webgl = {},
              opts = {
                projectileAlpha: 0.8,
                projectileLineWidth: 1.3,
                fireworkAngleSpan: 0.5,
                baseFireworkVel: 3,
                addedFireworkVel: 3,
                gravity: 0.03,
                lowVelBoundary: -0.2,
                xFriction: 0.995,
                baseShardVel: 1,
                addedShardVel: 0.2,
                fireworks: 1000,
                baseShardsParFirework: 10,
                addedShardsParFirework: 10,
                shardFireworkVelMultiplier: 0.3,
                initHueMultiplier: 1 / 360,
                runHueAdder: 0.1 / 360,
              };

            webgl.vertexShaderSource = `
uniform int u_mode;
uniform vec2 u_res;
attribute vec4 a_data;
varying vec4 v_color;

vec3 h2rgb( float h ){
	return clamp( abs( mod( h * 6. + vec3( 0, 4, 2 ), 6. ) - 3. ) -1., 0., 1. );
}
void clear(){
	gl_Position = vec4( a_data.xy, 0, 1 );
	v_color = vec4( 0, 0, 0, a_data.w );
}
void draw(){
	gl_Position = vec4( vec2( 1, -1 ) * ( ( a_data.xy / u_res ) * 2. - 1. ), 0, 1 );
	v_color = vec4( h2rgb( a_data.z ), a_data.w );
}
void main(){
	if( u_mode == 0 )
		draw();
	else
		clear();
}
`;
            webgl.fragmentShaderSource = `
precision mediump float;
varying vec4 v_color;

void main(){
	gl_FragColor = v_color;
}
`;

            webgl.vertexShader = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(webgl.vertexShader, webgl.vertexShaderSource);
            gl.compileShader(webgl.vertexShader);

            webgl.fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(webgl.fragmentShader, webgl.fragmentShaderSource);
            gl.compileShader(webgl.fragmentShader);

            webgl.shaderProgram = gl.createProgram();
            gl.attachShader(webgl.shaderProgram, webgl.vertexShader);
            gl.attachShader(webgl.shaderProgram, webgl.fragmentShader);

            gl.linkProgram(webgl.shaderProgram);
            gl.useProgram(webgl.shaderProgram);

            webgl.dataAttribLoc = gl.getAttribLocation(
              webgl.shaderProgram,
              "a_data"
            );
            webgl.dataBuffer = gl.createBuffer();

            gl.enableVertexAttribArray(webgl.dataAttribLoc);
            gl.bindBuffer(gl.ARRAY_BUFFER, webgl.dataBuffer);
            gl.vertexAttribPointer(
              webgl.dataAttribLoc,
              4,
              gl.FLOAT,
              false,
              0,
              0
            );

            webgl.resUniformLoc = gl.getUniformLocation(
              webgl.shaderProgram,
              "u_res"
            );
            webgl.modeUniformLoc = gl.getUniformLocation(
              webgl.shaderProgram,
              "u_mode"
            );

            gl.viewport(0, 0, w, h);
            gl.uniform2f(webgl.resUniformLoc, w, h);

            gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
            gl.enable(gl.BLEND);

            gl.lineWidth(opts.projectileLineWidth);

            webgl.data = [];

            webgl.clear = function () {
              gl.uniform1i(webgl.modeUniformLoc, 1);
              var a = 0.1;
              webgl.data = [
                -1,
                -1,
                0,
                a,
                1,
                -1,
                0,
                a,
                -1,
                1,
                0,
                a,
                -1,
                1,
                0,
                a,
                1,
                -1,
                0,
                a,
                1,
                1,
                0,
                a,
              ];
              webgl.draw(gl.TRIANGLES);
              gl.uniform1i(webgl.modeUniformLoc, 0);
              webgl.data.length = 0;
            };
            webgl.draw = function (glType) {
              gl.bufferData(
                gl.ARRAY_BUFFER,
                new Float32Array(webgl.data),
                gl.STATIC_DRAW
              );
              gl.drawArrays(glType, 0, webgl.data.length / 4);
            };

            var fireworks = [],
              tick = 0,
              sins = [],
              coss = [],
              maxShardsParFirework =
                opts.baseShardsParFirework + opts.addedShardsParFirework,
              tau = 6.283185307179586476925286766559;

            for (var i = 0; i < maxShardsParFirework; ++i) {
              sins[i] = Math.sin((tau * i) / maxShardsParFirework);
              coss[i] = Math.cos((tau * i) / maxShardsParFirework);
            }

            function Firework() {
              this.reset();
              this.shards = [];
              for (var i = 0; i < maxShardsParFirework; ++i)
                this.shards.push(new Shard(this));
            }
            Firework.prototype.reset = function () {
              var angle =
                  -Math.PI / 2 + (Math.random() - 0.5) * opts.fireworkAngleSpan,
                vel =
                  opts.baseFireworkVel + opts.addedFireworkVel * Math.random();

              this.mode = 0;
              this.vx = vel * Math.cos(angle);
              this.vy = vel * Math.sin(angle);

              this.x = Math.random() * w;
              this.y = h;

              this.hue = tick * opts.initHueMultiplier;
            };
            Firework.prototype.step = function () {
              if (this.mode === 0) {
                var ph = this.hue,
                  px = this.x,
                  py = this.y;

                this.hue += opts.runHueAdder;

                this.x += this.vx *= opts.xFriction;
                this.y += this.vy += opts.gravity;

                webgl.data.push(
                  px,
                  py,
                  ph,
                  opts.projectileAlpha * 0.2,
                  this.x,
                  this.y,
                  this.hue,
                  opts.projectileAlpha * 0.2
                );

                if (this.vy >= opts.lowVelBoundary) {
                  this.mode = 1;

                  this.shardAmount =
                    (opts.baseShardsParFirework +
                      opts.addedShardsParFirework * Math.random()) |
                    0;

                  var baseAngle = Math.random() * tau,
                    x = Math.cos(baseAngle),
                    y = Math.sin(baseAngle),
                    sin = sins[this.shardAmount],
                    cos = coss[this.shardAmount];

                  for (var i = 0; i < this.shardAmount; ++i) {
                    var vel =
                      opts.baseShardVel + opts.addedShardVel * Math.random();
                    this.shards[i].reset(x * vel, y * vel);
                    var X = x;
                    x = x * cos - y * sin;
                    y = y * cos + X * sin;
                  }
                }
              } else if (this.mode === 1) {
                this.ph = this.hue;
                this.hue += opts.runHueAdder;

                var allDead = true;
                for (var i = 0; i < this.shardAmount; ++i) {
                  var shard = this.shards[i];
                  if (!shard.dead) {
                    shard.step();
                    allDead = false;
                  }
                }

                if (allDead) this.reset();
              }
            };
            function Shard(parent) {
              this.parent = parent;
            }
            Shard.prototype.reset = function (vx, vy) {
              this.x = this.parent.x;
              this.y = this.parent.y;
              this.vx = this.parent.vx * opts.shardFireworkVelMultiplier + vx;
              this.vy = this.parent.vy * opts.shardFireworkVelMultiplier + vy;
              this.starty = this.y;
              this.dead = false;
              this.tick = 1;
            };
            Shard.prototype.step = function () {
              this.tick += 0.05;

              var px = this.x,
                py = this.y;

              this.x += this.vx *= opts.xFriction;
              this.y += this.vy += opts.gravity;

              var proportion = 1 - (this.y - this.starty) / (h - this.starty);

              webgl.data.push(
                px,
                py,
                this.parent.ph,
                opts.projectileAlpha / this.tick,
                this.x,
                this.y,
                this.parent.hue,
                opts.projectileAlpha / this.tick
              );

              if (this.y > h) this.dead = true;
            };

            function anim() {
              window.requestAnimationFrame(anim);

              webgl.clear();

              ++tick;

              if (fireworks.length < opts.fireworks)
                fireworks.push(new Firework());

              fireworks.map(function (firework) {
                firework.step();
              });

              webgl.draw(gl.LINES);
            }
            anim();

            window.addEventListener("resize", function () {
              w = c.width = window.innerWidth;
              h = c.height = window.innerHeight;

              gl.viewport(0, 0, w, h);
              gl.uniform2f(webgl.resUniformLoc, w, h);
            });
            window.addEventListener("click", function (e) {
              var firework = new Firework();
              firework.x = e.clientX;
              firework.y = e.clientY;
              firework.vx = 0;
              firework.vy = 0;
              fireworks.push(firework);
            });
          }
        }, 1000);
      });
    </script>
  </body>
</html>
